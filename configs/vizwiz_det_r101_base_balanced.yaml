_BASE_: "Base-RCNN.yaml"

# VizWiz Base Training Config with Class Balancing
# Addresses severe class imbalance (up to 451x ratio)

MODEL:
  WEIGHTS: "data/.pretrain_weights/ImageNetPretrained/MSRA/R-101.pkl"
  MASK_ON: False
  RESNETS:
    DEPTH: 101
  RPN:
    ENABLE_DECOUPLE: True
    BACKWARD_SCALE: 0.0
  ROI_HEADS:
    NUM_CLASSES: 75  # OD25 base split has 75 classes (FIXED from 101)
    ENABLE_DECOUPLE: True
    BACKWARD_SCALE: 0.75
    # Use focal loss to handle class imbalance
    SCORE_THRESH_TEST: 0.05  # Lower threshold for rare classes

DATASETS:
  TRAIN: ('vizwiz_train',)
  TEST: ('vizwiz_val',)

# ==================== CLASS BALANCING STRATEGIES ==================== #

# 1. Repeat Factor Sampling (oversample rare classes)
DATALOADER:
  SAMPLER_TRAIN: "RepeatFactorTrainingSampler"
  REPEAT_THRESHOLD: 0.001  # Oversample classes with <0.1% frequency
  NUM_WORKERS: 4

# 2. Training parameters optimized for imbalanced data
SOLVER:
  IMS_PER_BATCH: 16
  BASE_LR: 0.01  # Reduced from 0.02 for stability with imbalanced data
  WEIGHT_DECAY: 0.0001
  WEIGHT_DECAY_BIAS: 0.0001
  WEIGHT_DECAY_NORM: 0.0
  WARMUP_ITERS: 500  # Gradual warmup helps with rare classes
  WARMUP_FACTOR: 0.001
  STEPS: (6000,)
  MAX_ITER: 8000
  CHECKPOINT_PERIOD: 100000
  CLIP_GRADIENTS:
    ENABLED: True
    CLIP_TYPE: "norm"
    CLIP_VALUE: 1.0
    NORM_TYPE: 2.0

OUTPUT_DIR: "output/vizwiz_base_balanced"

# ==================== NOTES ==================== #
# This config addresses the severe class imbalance found:
# - monitor: 451 samples (most common)
# - purse: 1 sample (least common)  
# - Imbalance ratio: 451x
#
# RepeatFactorTrainingSampler will:
# - Oversample rare classes like "purse", "sign", "sandwich"
# - Balance the training distribution
# - Improve mAP on rare classes

